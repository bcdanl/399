---
title: "DANL 399: Data Visualization and Presentation"
subtitle: Make-up Midterm Exam
author: Byeong-Hak Choe
institute: SUNY Geneseo
date: 2024-04-04
format: 
  html
    # toc: true
    # toc-depth: 2
    # toc-expand: true
    # toc-title: Contents

execute:
  echo: true
  eval: true
  message: false
  warning: false
  fig-height: 5
  fig-width: 9
---
```{r}
#| include: false
library(tidyverse)
library(skimr)
library(lubridate)
library(stargazer)
library(broom)
library(hrbrthemes)
# theme_set(theme_ipsum())


theme_set(theme_ipsum() +
          theme(strip.background =element_rect(fill="lightgray"),
                axis.title.x = element_text(size = rel(1.5) ),
                axis.title.y = element_text(size = rel(1.5),
                                            angle = 0))
          )

```
# Honor Pledges

I solemnly swear that I will not cheat or engage in any form of academic dishonesty during this exam. 

I will not communicate with other students or use unauthorized materials. 

I will uphold the integrity of this exam and demonstrate my own knowledge and abilities.

By taking this pledge, I acknowledge that academic dishonesty undermines the academic process and is a violation of the trust placed in me as a student. 

I accept the consequences of any violation of this promise.

- Student's Name: 
- Student's ID: 
- Student's Signature: 



# Load R packages
- Here we are loading all the R packages we need for the Midterm Exam I, so that you do not need to load the R packages in your code.
```{r}
#| echo: true
library(tidyverse)
library(skimr)
library(ggrepel)
library(hrbrthemes)
```


<br><br>

# Question 1

The following describes the context of the data.frame, `banks`.

- In the 1920s, Caldwell and Company, a prominent Southern banking chain, thrived. By the time of the Great Crash in 1929, Caldwell & Company was a regional investment banking powerhouse doing $100,000,000 a year in securities sales alone. However, mismanagement and the stock market crash of October 1929 brought the Caldwell empire down in November 1930, triggering bank failures across several states.

- Banks fundamentally rely on trust. They lend more than they hold, assuming not all depositors will withdraw simultaneously. But when confidence wanes, as in the 1930s, bank runs can ensue. Caldwell's collapse notably impacted trust in the South, leading to a banking crisis in Mississippi in December 1930.

- Economists debate the role of monetary policy during such crises. The Federal Reserve, divided into 12 districts, had varied responses. The Atlanta Fed actively extended loans to struggling banks, whereas the St. Louis Fed took a more cautious approach. Mississippi, straddling these districts, became a study in contrasting policies. 

- Within 4 weeks of Caldwell’s collapse, the Atlanta Fed had increased bank lending by about 40% in the Sixth District, where policy was to increase lending. In the same period, bank lending by the St. Louis Fed in the Eighth District fell only about 10%, where policy was to do little or even restrict lending.

- Beginning in July 1931, the St. Louis Fed abandoned tight money and started lending to troubled banks freely. In other words, after 1931, Federal Reserve policy in the two districts was again similar, with both regional Feds willing to provide liquidity with a free hand. Moreover, while the Depression was far from over in 1932, the Caldwell crisis had petered out and withdrawals had returned to pre-crisis levels. Given the two regional Feds’ common readiness to lend as the need arose, trends in bank activity should again have been common after 1931.

- The followings are the data frames for Question 1.


```{r}
#| echo: true
banks_all <- read_csv('https://bcdanl.github.io/data/banks_ms_all.csv')

```

## Description for Variables in `banks_all`

- `year`: Year


- `month`: Month


- `day`: Day


- `bib6`: The number of banks in business in the Sixth District


- `bib8`: The number of banks in business in the Eighth District

<br>


```{r}
#| echo: true
banks <- read_csv('https://bcdanl.github.io/data/banks_ms.csv')
```
## Description for Variables in `banks`

- `year`: Year


- `month`: Month


- `day`: Day


- `district`: District
  - `bib6`: The Sixth District
  - `bib8`: The Eighth District
  - `counterfactual`: The Sixth District Counterfactual. The counterfactual evolution of the number of banks in the Sixth District if the same number of banks had failed in that district after 1930 as did in the Eighth.
  

- `n_banks`: The number of banks in business


<br>


## Q1a
- Provide your R code to create a new data.frame, `bank7_1`, which contains the observations with only July 1st for each year in the data.frame `banks_all`.

<br>



```{r}
#| eval: false

bank7_1 <- banks_all |> 
  filter(month == "July")

bank7_1 <- bank7_1 |> 
  filter(day == 1)
```

<br><br>


## Q1b
- Provide your R code to calculate the median, mean, and standard deviation of the number of banks in business in each district in the data.frame `banks_all`.

<br>



```{r}
#| eval: false
skim(banks$bib6)
skim(banks$bib8)
```

<br><br>



## Q1c.
- Provide the ggplot code to replicate the following ggplot figure that describes how the distribution of the number of banks in business varies by district.
  - Blue color corresponds to the Sixth district.
  - Red color corresponds to the Eighth district.

```{r q1c}
ggplot(banks_all) +
  geom_freqpoly(aes(x = bib6),
                 bins = 100, 
                 color = 'blue') +
  geom_histogram(aes(x = bib8),
                 bins = 100, 
                 fill = 'red', alpha = .5) +
  labs(x = "Number of banks in business")
```

<br>



<br><br>

## Q1d.
- Provide the ggplot code with the data.frame `banks` to replicate the following ggplot figure that describes the yearly trend of the number of banks in business for each district.
  - The dotted line is from the observation with "counterfactual" `district` value .
  - The logical condition  `district != "counterfactual"` returns `TRUE` if the value of `district` is not equal to "counterfactual".
  - The logical condition  `district != "counterfactual"` returns `FALSE` if the value of `district` is equal to "counterfactual".
  - The number of banks in business in this figure was measured on July 1st in each year.


```{r q1d}
#| fig-height: 6
ggplot(data = banks |> 
         filter(district != "counterfactual"),
       aes(x = year, y = n_banks)) +
  geom_line(aes(color = district),
            show.legend = F) +
  geom_line(data = banks |> 
              filter(district == "counterfactual"),
            linetype = 2
            ) +
  geom_point() +
  geom_point(data = banks |> 
               filter(district == "counterfactual")) +
  geom_vline(xintercept = 1930 + 5/12, linetype = 3) +
  geom_label_repel(data = banks |> 
                     filter(year == 1934),
                   aes(x = 1934, label = district),
                   box.padding = .75,
                   nudge_x = .33) +
  scale_x_continuous(breaks = c(1929, 1930, 1930 + 5/12, 1931, 1932, 1933, 1934, 1935),
                     label = c('1929', '1930', 'Dec\n1930', '1931', '1932', '1933', '1934', '1935'),
                     limits = c(1929,1935)
                     ) +
  theme(axis.text.x = element_text(angle = 0))

```

<br>




## Q1e.


- Considering the context of the data.frame, `banks`, and the ggplot figure in Q1d, make a detailed comment on the following questions:
  - Describe and compare the yearly trend of the number of banks in business depicted in the ggplot figure in Q1d.
  - What would be the effect of the monetary policy on bank failures in Mississippi in July 1934?
  - In the given ggplot figure in Q1d, point out the magnitude of such effect.
  

<br>



<br><br>




# Question 2

The following is the data.frame `gapminder` from the `gapminder` R package for Question 2.

```{r}
#| echo: true
library(gapminder)
gapminder <- gapminder::gapminder
```

## Variable description
- `country`: factor with 142 levels

- `continent`: factor with 5 levels

- `year`: ranges from 1952 to 2007 in increments of 5 years

- `lifeExp`: life expectancy at birth, in years

- `pop`:  population

`gdpPercap`
GDP per capita (US$, inflation-adjusted)

<br>


## Q2a.
- Provide ggplot code to replicate the following visualization that describes (1) the time trend of `log10(gdpPercap)` for each `country` and (2) the time trend of `log10(gdpPercap)` for each `continent`.
  - The time trend of `log10(gdpPercap)` for each `continent`, depicted by the blue curve, is from the prediction based on the data points of `year` and `log10(gdpPercap)`.
  - The time trend of `log10(gdpPercap)` for each `country`, depicted by the "grey" curve, is from the data points of `year` and `log10(gdpPercap)` for that `country`.

```{r q2a}
#| fig-height: 7
p <- ggplot(data = gapminder,
            mapping = aes( x = year,
                           y = gdpPercap,
                           group = country) )

p + geom_line(color="gray70", aes(group = country)) +
    geom_smooth(size = 1.1, method = "loess", se = FALSE,
                aes(group = continent)) +
    facet_wrap(continent ~.) +
    scale_y_log10(labels=scales::dollar) +
    theme(axis.text.x = element_text(angle = 45),
          axis.title.x = element_text(margin = margin(t = 0, b = 0, l = 0, r = 0))) 

```



<br><br>

## Q2b.
- Interpret the visualization in Q2a.

<br>



<br><br>


## Q2c.
- Provide ggplot code to replicate the following visualization that describes (1) the relationship between `log10(gdpPercap)` and `lifeExp` in `year` 2007, excluding the `continent` "Oceania".
  - The size of dots varies by `pop`.

```{r q2c}
#| warning: false
#| message: false
#| fig-height: 9
p <- ggplot(data = gapminder |> filter(year == 2007) |> filter(continent != "Oceania"),
            mapping = aes( x = gdpPercap,
                           y = lifeExp,
                   color = continent) )

p + geom_point(alpha = .5, 
               aes(size = pop)) +
  geom_smooth(se = T, method = lm, aes(fill = continent)) +
  ggrepel::geom_text_repel(data = gapminder |> filter(year == 2007, 
                                                      country %in% c("United States", "China", "India", "Nigeria") ),
                           aes(label = country),
                           box.padding = 3,
                           nudge_x = .5,
                           show.legend = F) +
  guides(color = guide_legend(label.position = "bottom",
                              keywidth = 3, order = 1),
         size = guide_legend(label.position = "bottom",
                              keywidth = 3, order = 2),
         fill = guide_legend(label.position = "bottom",
                              keywidth = 3, order = 1),
         ) +
  scale_x_log10(labels = scales::comma) +
  scale_color_brewer(palette = "Dark2") + 
  scale_fill_brewer(palette = "Dark2") + 
  scale_size_continuous(breaks = c(10^8, 2*10^8, 4*10^8, 6*10^8), labels = scales::comma) +
  labs(y = "Life\nExpectancy",
       x = "GDP per capita",
       size = "Population",
       ) +
  theme(legend.position = "top")

```

<br>



<br><br>

## Q2d.
- Interpret the visualization in Q2c.
  - In your interpretation, please explain the deviation of Nigeria from the overall relationship between `log10(gdpPercap)` and `lifeExp` in Africa.

<br>



<br><br>




# Question 3

The followings are the data.frames for Question 3.

```{r}
#| echo: true
titanic_1 <- read_csv("https://bcdanl.github.io/data/titanic.csv")
```


## Description for Variables in `titanic_1`

- `Class`: Social class

- `Sex`: Sex

- `Age`: Age

- `Survived`: Survival status from the Titanic disaster.

<br>

<br>


```{r}
#| echo: true

titanic_2 <- read_csv("https://bcdanl.github.io/data/titanic_2.csv")
```


## Description for Variables in `titanic_2`

- `pclass`: Social class

- `sex`: Sex

- `age`: Age

- `survived`: Survival status from the Titanic disaster.

<br>

<br>



## Q3a.
- Provide ggplot code with the `titanic_1` data.frame to replicate the following visualization that describes how the distribution of `Sex` varies by `Survived`, `Age`, and `Class`.

```{r q3a}
p <- ggplot(data = titanic_1,
            mapping = aes(x = Survived, fill = Sex))

p + geom_bar(position = "fill", color = 'black') +
  facet_grid(Age ~ Class) +
  scale_y_percent() +
  scale_fill_manual(values = c('#cd4f39', '#4f632d')) +
  labs(y = "Percent") +
  guides(color = guide_legend(label.position = "bottom",
                              keywidth = 3)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.title.y = element_text(margin = margin(0, 15, 0, 0)))
```

<br>



<br><br>



## Q3b.

Make a detailed comment on the visualization in Q3a.



<br><br>


## Q3c.
- Provide ggplot code with the `titanic_2` data.frame to replicate the following visualization that describes how the distribution of `age` varies by `survived`, `pclass`, and `sex`.
  - Use the following colors: `#4c3642` and `#d399e7`.
  - The number of bins in each subplot is 25.

```{r q3c}
#| fig-height: 9
ggplot(data = titanic_2 |> 
         filter(!is.na(pclass), !is.na(sex)),
       ) +
  geom_freqpoly(aes(x = age, y = stat(count / sum(count)), 
                    color = survived ), 
                bins = 20,
                linewidth = rel(2)) +
  scale_color_manual(values = c('#4c3642','#d399e7')) +
  facet_grid(pclass ~ sex) +
  scale_y_percent() +
  labs(y = "Percent",
       color = "Survived?") +
  guides(color = guide_legend(reverse = T,
                              label.position = "bottom",
                              keywidth = 3)) +
  theme(legend.position = "top",
        axis.title.y = element_text(margin = margin(0, 15, 0, 0)))
```

<br>



<br><br>


## Q3d.

Make a detailed comment on the visualization in Q3c.




<br><br>


# Question 4 

In September 2019, YouGov survey asked 1,639 GB adults the following question:

> In hindsight, do you think Britain was right/wrong to vote to leave EU?
>
> -   Right to leave\
> -   Wrong to leave\
> -   Don't know

The data from the survey is in `brexit.csv`.

```{r}
#| message: false
#| echo: true

brexit <- read_csv('https://bcdanl.github.io/data/brexit.csv')
```


<br>

## Q4a

- Replicate the following visualization

```{r a4a}
#| echo: true
brexit <- brexit |> 
  mutate(
    region = fct_relevel(region, 
                         "london", "rest_of_south", "midlands_wales", "north", "scot"),
    region = fct_recode(region, 
                        London = "london", 
                        `Rest of South` = "rest_of_south", 
                        `Midlands / Wales` = "midlands_wales", 
                        North = "north", 
                        Scotland = "scot")
  )

ggplot(brexit, 
       aes(y = opinion, fill = opinion)) +
  geom_bar() +
  facet_wrap( ~ region, 
             nrow = 1, 
             labeller = label_wrap_gen(width = 12)) +
  guides(fill = "none") +
  labs(
    title = "Was Britain right/wrong to vote to leave EU?",
    subtitle = "YouGov Survey Results, 2-3 September 2019",
    caption = "Source: bit.ly/2lCJZVg",
    x = NULL, y = NULL
  ) +
  scale_fill_manual(values = c(
    "gray",
    "#67a9cf",
    "#ef8a62"
  )) +
  theme_minimal()
```

<br><br>

## Q4b
- Replicate the following visualization
  - How is the story this visualization telling different than the story the plot in Q4a?


```{r q4b}
ggplot(brexit, 
       aes(y = opinion, fill = opinion)) +
  geom_bar() +
  facet_wrap(~region, scales = 'free_x',
    nrow = 1, labeller = label_wrap_gen(width = 12),
    # ___
  ) +
  guides(fill = "none") +
  labs(
    title = "Was Britain right/wrong to vote to leave EU?",
    subtitle = "YouGov Survey Results, 2-3 September 2019",
    caption = "Source: bit.ly/2lCJZVg",
    x = NULL, y = NULL
  ) +
  scale_fill_manual(values = c(
    "Wrong" = "#ef8a62",
    "Right" = "#67a9cf",
    "Don't know" = "gray"
  )) +
  theme_minimal()
```

<br><br>

## Q4c

- First, calculate the proportion of wrong, right, and don't know answers in each region and then plot these proportions (rather than the counts) and then improve axis labeling. 

```{r}
#| echo: true
q4 <- brexit |> 
  group_by(region, opinion) |>  
  summarise(n = n()) |> 
  mutate(tot = sum(n),
         prop = n / tot ) 
```



- Replicate the following visualization
  - How is the story this visualization telling different than the story the plot in Q4b?



```{r q4c}
ggplot(q4, aes(y = opinion, x = prop,
               fill = opinion)) +
  geom_col() +
  facet_wrap(~region,
    nrow = 1, labeller = label_wrap_gen(width = 12),
    # ___
  ) +
  guides(fill = "none") +
  labs(
    title = "Was Britain right/wrong to vote to leave EU?",
    subtitle = "YouGov Survey Results, 2-3 September 2019",
    caption = "Source: bit.ly/2lCJZVg",
    x = 'Percent', y = NULL
  ) +
  scale_fill_manual(values = c(
    "Wrong" = "#ef8a62",
    "Right" = "#67a9cf",
    "Don't know" = "gray"
  )) +
  scale_x_continuous(labels = scales::percent) +
  theme_minimal()
```

<br><br>

## Q4d.

- Recreate the same visualization from the previous exercise, this time dodging the bars for opinion proportions for each region, rather than faceting by region and then improve the legend.

  - How is the story this visualization telling different than the story the previous plot tells?

```{r q4d}
ggplot(q4, aes(y = region, x = prop,
               fill = opinion)) +
  geom_col(position = "dodge") +
  labs(
    title = "Was Britain right/wrong to vote to leave EU?",
    subtitle = "YouGov Survey Results, 2-3 September 2019",
    caption = "Source: bit.ly/2lCJZVg",
    x = 'Percent', y = NULL, fill = 'Opinion'
  ) +
  scale_fill_manual(values = c(
    "Wrong" = "#ef8a62",
    "Right" = "#67a9cf",
    "Don't know" = "gray"
  )) +
  scale_x_continuous(labels = scales::percent) +
  theme_minimal() 

```

